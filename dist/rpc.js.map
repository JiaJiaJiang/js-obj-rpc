{"version":3,"file":"rpc.js","sources":["../index.js","../index.js?commonjs-entry"],"sourcesContent":["/*\r\nCopyright luojia@luojia.me\r\nMIT LICENSE\r\n*/\r\n\r\n/* \r\nmessage structure\r\nByte 0-3\t\ta fixed 4 bytes random id for check if this message is valid for this session, default is filled by 0\r\nByte 4\r\n\t[0] \t\t0:request\r\n\t\t\t\t1:response\r\n\t[1] request:\t0: no id\r\n\t\t\t\t\t1:has id\r\n\t\tresponse:\t0:normal response\r\n\t\t\t\t\t1:error message\r\n\t[2] reserved\r\n\t[3-7] message type\r\n\t\t0-7: \tsee: ControlMsg\r\n\t\t8:\t\tdata true\r\n\t\t9:\t\tdata false\r\n\t\t10:\t\tdata binary\r\n\t\t11:\t\tdata string\r\n\t\t12:\t\tdata json string\r\n\t\t13:\t\tdata double js number\r\n\t\t14:\t\tdata undefined\r\n\t\t15:\t\tdata null\r\n\t\t16:\t\tdata bigint\r\n\t\t16-31:\treserved\r\n[\r\n\tByte 5-8\r\n\t\tmessage id (if has id or is a response)\r\n\tByte 9-12\r\n\t\trandom number\r\n]\r\nByte -\r\n\tdata\r\n*/\r\n\r\n\r\nconst SUPPORT_ARRAYBUFFER = !!global.ArrayBuffer;\r\nconst TypedArray = SUPPORT_ARRAYBUFFER && global.Float32Array.prototype.constructor.__proto__;\r\nif (SUPPORT_ARRAYBUFFER && !ArrayBuffer.isView) {//ArrayBuffer.isView\r\n\tArrayBuffer.isView = a => !!((TypedArray && (a instanceof TypedArray)) || (global.DataView && (a instanceof DataView)));\r\n}\r\n\r\nconst encoder = new TextEncoder();\r\nconst decoder = new TextDecoder()\r\nconst tmpFloat64Array1 = new Float64Array(1),\r\n\ttmpUint8Array5 = new Uint8Array(5),\r\n\ttmpUint8Array13 = new Uint8Array(13);\r\nfunction strToUint8(str) {\r\n\treturn encoder.encode(str);\r\n}\r\nfunction uint8ToStr(uint8) {\r\n\treturn decoder.decode(uint8);\r\n}\r\nfunction getSliceInArrayBuffer(typedArray) {\r\n\treturn typedArray.buffer.slice(typedArray.byteOffset, typedArray.byteOffset + typedArray.byteLength);\r\n}\r\nfunction concatArrayBuffers(buffers) {\r\n\tlet offsets = new Array(buffers.length), totalLength = 0;\r\n\tfor (let ai = 0; ai < buffers.length; ai++) {\r\n\t\toffsets[ai] = totalLength;\r\n\t\ttotalLength += buffers[ai].byteLength;\r\n\t\tif (buffers[ai] instanceof ArrayBuffer) {\r\n\t\t\tbuffers[ai] = new Uint8Array(buffers[ai]);\r\n\t\t}\r\n\t}\r\n\tconst result = new Uint8Array(totalLength);\r\n\tfor (let i = 0; i < buffers.length; i++) {\r\n\t\tresult.set(buffers[i], offsets[i]);\r\n\t}\r\n\treturn result;\r\n}\r\n/**\r\n * @description\tMessage object\r\n * @class Message\r\n */\r\nclass Message {\r\n\tid;\r\n\trandom;\r\n\thead;\r\n\ttype;\r\n\t_data;\r\n\thasID;\r\n\tpayload;\r\n\tsessionId;\r\n\tisRequest;\r\n\t/**\r\n\t * Creates an instance of Message.\r\n\t * @param {ArrayBuffer} data\r\n\t */\r\n\tconstructor(data) {\r\n\t\tthis.sessionId = new DataView(data.buffer, data.byteOffset, data.byteLength).getUint32(0);\r\n\t\tdata = data.subarray(4);\r\n\t\tif (ArrayBuffer.isView(data) || (data instanceof ArrayBuffer) === true) data = new Uint8Array(data);\r\n\t\telse {\r\n\t\t\tthrow (new TypeError('Wrong data'));\r\n\t\t}\r\n\t\tif (data.byteLength === 0) {\r\n\t\t\tthrow (new Error('Bad message'));\r\n\t\t}\r\n\t\tdata = new Uint8Array(data);\r\n\t\tthis.head = data[0];\r\n\t\tthis.isRequest = (this.head & 0b10000000) === 0;\r\n\t\tthis.hasID = this.isRequest ? (this.head & 0b01000000) === 0b01000000 : true;\r\n\t\t// this.finished=(head&0b00100000)===0b00100000;//finished flag\r\n\t\tif (this.hasID) {//calc id\r\n\t\t\tif (data.byteLength < 5) {\r\n\t\t\t\tthrow (new Error('Bad message'));\r\n\t\t\t}\r\n\t\t\tconst view = new DataView(data.buffer, data.byteOffset, data.byteLength);\r\n\t\t\tthis.id = view.getUint32(1);\r\n\t\t\tthis.random = view.getUint32(5);\r\n\t\t}\r\n\t\tthis.type = this.head & 0b00011111;//type of the message\r\n\t\tthis.payload = data.buffer.slice(data.byteOffset + this.hasID ? 9 : 1, data.byteLength);\r\n\t\tthis._data;//data cache\r\n\t}\r\n\t/**\r\n\t * @description\tis control message\r\n\t * @readonly\r\n\t */\r\n\tget isCtrl() {\r\n\t\treturn this.type < 8;\r\n\t}\r\n\t/**\r\n\t * @description\tis error message\r\n\t * @readonly\r\n\t */\r\n\tget isError() {\r\n\t\tif ((this.head & 0x40) === 0x40) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\t/**\r\n\t * @description parse data\r\n\t * @returns {any}\tcarried data\r\n\t */\r\n\tdata() {\r\n\t\tif (this._data !== undefined) return this._data;\r\n\t\tthis._data = (() => {\r\n\t\t\tif (this.type < 8) return ControlMsg.parseData(this.type, this.payload);\r\n\t\t\tswitch (this.type) {\r\n\t\t\t\tcase 8: return true;\r\n\t\t\t\tcase 9: return false;\r\n\t\t\t\tcase 10: return this.payload;//binary\r\n\t\t\t\tcase 11: return uint8ToStr(this.payload);//string\r\n\t\t\t\tcase 12: return JSON.parse(uint8ToStr(this.payload));//json\r\n\t\t\t\tcase 13://js number\r\n\t\t\t\t\tif (this.payload.byteLength !== 8)\r\n\t\t\t\t\t\tthrow ('Wrong data length for number');\r\n\t\t\t\t\tconst view = new DataView(this.payload);\r\n\t\t\t\t\treturn view.getFloat64(0);\r\n\t\t\t\tcase 14: return undefined;\r\n\t\t\t\tcase 15: return null;\r\n\t\t\t\tcase 16: {\r\n\t\t\t\t\tconst bStr = uint8ToStr(this.payload);\r\n\t\t\t\t\tif (bStr[0] === '-') return -BigInt('0x' + bStr.slice(1));\r\n\t\t\t\t\treturn BigInt('0x' + bStr);\r\n\t\t\t\t}\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthrow ('Unknown data type');\r\n\t\t\t}\r\n\t\t})();\r\n\t\treturn this._data;\r\n\t}\r\n\t/**\r\n\t * @description\tconvert different data to message format buffer\r\n\t * @static\r\n\t * @param {any} data\tdata that defined at top of this file\r\n\t * @returns {[number,ArrayBuffer]}\t[type code, data buffer]\r\n\t */\r\n\tstatic toFrameData(data) {\r\n\t\tif (data === undefined) return [14];\r\n\t\tif (data === null) return [15];\r\n\t\tif (data === true) return [8];\r\n\t\tif (data === false) return [9];\r\n\t\tif (data instanceof ControlMsg) {\r\n\t\t\treturn [data.code, data.buf];\r\n\t\t}\r\n\t\tif (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\r\n\t\t\treturn [10, data.buffer ? getSliceInArrayBuffer(data) : data];\r\n\t\t}\r\n\t\tif (data instanceof Error) {\r\n\t\t\tif (this.debug) console.error(data);\r\n\t\t\tthrow (new TypeError('Dont use Error, use RPC.Error instead'));\r\n\t\t}\r\n\t\tif (data instanceof ErrorMsg) {\r\n\t\t\treturn [12, strToUint8(JSON.stringify({ code: data.code || 4100, msg: data.msg }))];\r\n\t\t}\r\n\t\tswitch (typeof data) {\r\n\t\t\tcase 'string': return [11, strToUint8(data)];\r\n\t\t\tcase 'object': return [12, strToUint8(JSON.stringify(data))];\r\n\t\t\tcase 'number':\r\n\t\t\t\tconst view = new DataView(tmpFloat64Array1.buffer, tmpFloat64Array1.byteOffset, tmpFloat64Array1.byteLength);\r\n\t\t\t\tview.setFloat64(0, data);\r\n\t\t\t\treturn [13, getSliceInArrayBuffer(view)];\r\n\t\t\tcase 'bigint':\r\n\t\t\t\treturn [16, strToUint8(data.toString(16))];\r\n\t\t}\r\n\t\t// console.error('data: ',data);//debug\r\n\t\tthrow (new TypeError('Unsupported data type: ' + typeof data));\r\n\t}\r\n\t/**\r\n\t * @description\tpack data into message buffer\r\n\t * @static\r\n\t * @param {boolean} req\tis request\r\n\t * @param {boolean} err\tis error\r\n\t * @param {number} type\ttype code\r\n\t * @param {ArrayBuffer} buf\tdata buffer\r\n\t * @param {number} id\tmessage id\r\n\t * @param {number} randomNum\ta random number for preventing id confict\r\n\t * @returns {ArrayBuffer}  \r\n\t */\r\n\tstatic _pack(sessionId, req, err, type, buf, id, randomNum) {\r\n\t\tlet hasID = typeof id === 'number' && id > 0;\r\n\t\tlet array = (hasID ? tmpUint8Array13 : tmpUint8Array5);//alloc the head buffer\r\n\t\tarray.fill(0);\r\n\t\tconst view = new DataView(array.buffer, array.byteOffset, array.byteLength);\r\n\t\tview.setUint32(0, sessionId);\r\n\t\tconst head = array.subarray(4, hasID ? 13 : 5);\r\n\t\tif (req === true) {//request\r\n\t\t\tif (hasID) head[0] |= 0b01000000;//set id flag\r\n\t\t} else {//response\r\n\t\t\thead[0] = 0b10000000;//set as response\r\n\t\t\tif (err) { head[0] |= 0b01000000; }//set err msg flag\r\n\t\t}\r\n\t\thead[0] |= type;\r\n\t\tlet bufs = [array];\r\n\t\tif (hasID) {\r\n\t\t\tif (id >= 0xFFFFFFFF)\r\n\t\t\t\tthrow (new Error('id out of range'));\r\n\t\t\tview.setUint32(5, id);//write id\r\n\t\t\tview.setUint32(9, randomNum);//write randomNum\r\n\t\t}\r\n\t\tif (buf && buf.byteLength) bufs.push(buf);\r\n\t\treturn concatArrayBuffers(bufs);\r\n\t}\r\n\t/**\r\n\t * @description\tpack data into message buffer\r\n\t * @static\r\n\t * @param {boolean} req\tis request\r\n\t * @param {any} data\tdata to send\r\n\t * @param {number} id\tmessage id\r\n\t * @param {number} randomNum\ta random number for preventing id confict\r\n\t * @returns {ArrayBuffer}\tpacked message\r\n\t */\r\n\tstatic pack(sessionId, req, data, id, randomNum) {\r\n\t\tlet [type, buf] = Message.toFrameData(data);//get data type and meg buffer\r\n\t\tlet err = data instanceof ErrorMsg;\r\n\t\treturn Message._pack(sessionId, req, err, type, buf, id, randomNum);\r\n\t}\r\n\tstatic msgErrorCodes = {\r\n\t\t4100: '',//free message\r\n\t\t4101: 'Forbidden',\r\n\t\t4102: 'Cannot parse the data',\r\n\t\t4103: 'Not supported operation',\r\n\t\t4104: 'Duplicate id',\r\n\t\t4105: 'Time out',\r\n\t}\r\n\t/**\r\n\t * @description\tis valid id\r\n\t * @static\r\n\t * @param {number} id\r\n\t * @returns {boolean}\r\n\t */\r\n\tstatic isValidId(id) {\r\n\t\treturn typeof id === 'number' && id > 0 && id <= 0xFFFFFFFF;\r\n\t}\r\n}\r\n\r\n/**\r\n * @description error message\r\n * @class ErrorMsg\r\n */\r\nclass ErrorMsg {\r\n\t/**\r\n\t * Creates an instance of ErrorMsg.\r\n\t * @param {any} code\terror code to return\r\n\t * @param {string} [msg='']\terror message to return\r\n\t */\r\n\tconstructor(code, msg = '') {\r\n\t\tthis.code = code;\r\n\t\tif (typeof msg === 'string') {\r\n\t\t\tthis.msg = msg;\r\n\t\t} else if (msg instanceof Error) {\r\n\t\t\tthis.msg = msg.message;\r\n\t\t} else {\r\n\t\t\tthrow (new Error('Not supported message type'));\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @description control message\r\n * @class ControlMsg\r\n */\r\nclass ControlMsg {\r\n\tstatic cache = {};\r\n\tstatic codes = {\r\n\t\tabort: 1,//abort an operation\r\n\t}\r\n\tcode;\r\n\tbuf;\r\n\t/**\r\n\t * Creates an instance of ControlMsg.\r\n\t * @param {string} name name of the control operation\r\n\t * @param {*} data\tdata of the control message\r\n\t */\r\n\tconstructor(name, data) {\r\n\t\tif (name in ControlMsg.codes === false) {\r\n\t\t\tthrow (new Error('Unknown operation name'));\r\n\t\t}\r\n\t\tthis.code = ControlMsg.codes[name];\r\n\t\tswitch (this.code) {\r\n\t\t\tcase ControlMsg.codes.abort://abort message\r\n\t\t\t\tif (!Message.isValidId(data))\r\n\t\t\t\t\tthrow ('Invalid id: ' + data);\r\n\t\t\t\tthis.buf = new ArrayBuffer(4);\r\n\t\t\t\t(new DataView(this.buf)).setUint32(0, data);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\tconvert control message payload to number\r\n\t * @static\r\n\t * @param {number} code\tcontrol code\r\n\t * @param {ArrayBuffer} buf\tcontrol message payload\r\n\t * @returns {number}  \r\n\t */\r\n\tstatic parseData(code, buf) {\r\n\t\tswitch (code) {\r\n\t\t\tcase ControlMsg.codes.abort:\r\n\t\t\t\treturn (new DataView(buf)).getUint32(0);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @description request from remote\r\n * @class Request\r\n */\r\nclass Request {\r\n\tresponded = false;\r\n\ttimeout;\r\n\t/**\r\n\t * Creates an instance of Request.\r\n\t * @param {RPC} rpc\r\n\t * @param {number} id\tmessage id\r\n\t * @param {function(...any)} callback\treceive response data\r\n\t * @param {number} random\ta random number for preventing id confict\r\n\t */\r\n\tconstructor(rpc, id, callback, random) {\r\n\t\tthis.id = id;\r\n\t\tthis.rpc = rpc;\r\n\t\tthis.cb = callback;\r\n\t\tthis.random = random;\r\n\t}\r\n\t/**\r\n\t * @description\tabort the request, depends on remote data handle\r\n\t * @returns {Request} the abort request\r\n\t */\r\n\tabort() {\r\n\t\ttry {\r\n\t\t\treturn this.rpc.control('abort', this.id);\r\n\t\t} catch (err) {\r\n\t\t\t//nothing\r\n\t\t} finally {\r\n\t\t\tthis.rpc.delete(this);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\tfill response data when the remote rpc respond\r\n\t * @param {*} args\r\n\t */\r\n\tcallback(...args) {\r\n\t\tif (this.responded)\r\n\t\t\tthrow (new Error('RPC responded'));\r\n\t\tthis.responded = true;\r\n\t\tif (this.cb)\r\n\t\t\tthis.cb(...args);\r\n\t}\r\n\t/**\r\n\t * @description set timeout of the request\r\n\t * @param {*} time\r\n\t */\r\n\tsetTimeout(time) {\r\n\t\tif (typeof time !== 'number' || !(time >= 0))\r\n\t\t\tthrow (new Error('Wrong timeout'));\r\n\t\tif (this.timeout)\r\n\t\t\tclearTimeout(this.timeout);\r\n\t\tthis.timeout = setTimeout(() => this._timeout(), time);\r\n\t}\r\n\t/**\r\n\t * @description when timeout reaches, an abort control will be sent\r\n\t */\r\n\t_timeout() {\r\n\t\tthis.callback(new Error('Time out'));\r\n\t\tthis.rpc.delete(this);\r\n\t\tthis.timeout = 0;\r\n\t}\r\n\t_destructor() {\r\n\t\tthis.cb = null;\r\n\t\tthis.rpc = null;\r\n\t\tif (this.timeout) {\r\n\t\t\tclearTimeout(this.timeout);\r\n\t\t\tthis.timeout = 0;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n\r\n/**\r\n * @description incoming request\r\n * @class InRequest\r\n */\r\nclass InRequest {\r\n\t_timeout;\r\n\taborted = false;\r\n\tresponded = false;\r\n\tsource;\r\n\trpc;\r\n\tmsg;\r\n\tonAbort(data) { }//overwrite this\r\n\t/**\r\n\t * Creates an instance of InRequest.\r\n\t * @param {Message} Message_msg\r\n\t * @param {RPC} rpc\r\n\t * @param {*} source define a source, which will be attached to request object\r\n\t */\r\n\tconstructor(Message_msg, rpc, source) {\r\n\t\tthis.rpc = rpc;\r\n\t\tthis.msg = Message_msg;\r\n\t\tthis.source = source;\r\n\t}\r\n\t/**\r\n\t * @description\tget message id\r\n\t * @readonly\r\n\t */\r\n\tget id() { return this.msg.id; }\r\n\t/**\r\n\t * @description\tget data of the message, wil be recovered to thier origin type\r\n\t * @returns {any}  \r\n\t */\r\n\tdata() {\r\n\t\treturn this.msg.data();\r\n\t}\r\n\t/**\r\n\t * @description\tset timeout of the incoming request\r\n\t * @param {*} time\r\n\t */\r\n\tsetTimeout(time) {\r\n\t\tif (typeof time !== 'number' || !(time >= 0))\r\n\t\t\tthrow (new Error('Wrong timeout'));\r\n\t\tif (this._timeout)\r\n\t\t\tclearTimeout(this._timeout);\r\n\t\tthis._timeout = setTimeout(() => this._reachTimeout(), time);\r\n\t}\r\n\t_abortMsg(str_msg) {\r\n\t\tif (this.aborted)\r\n\t\t\tthrow (new Error('request already aborted'));\r\n\t\tthis.aborted = true;\r\n\t\treturn this.onAbort(str_msg);\r\n\t}\r\n\t/**\r\n\t * @description when timeout reaches, rpc will send an error back to remote\r\n\t */\r\n\tasync _reachTimeout() {\r\n\t\tthis._timeout = 0;\r\n\t\ttry {\r\n\t\t\tawait this._abortMsg('time out');\r\n\t\t\tthis.rpc._respond(this, RPC.Error(4105));\r\n\t\t} catch (err) {\r\n\t\t}\r\n\t}\r\n\t_destructor() {\r\n\t\tthis.rpc = null;\r\n\t\tthis.msg = null;\r\n\t\tif (this._timeout) {\r\n\t\t\tclearTimeout(this._timeout);\r\n\t\t\tthis._timeout = 0;\r\n\t\t}\r\n\t}\r\n}\r\n/**\r\n * @description RPC handle\r\n * @class RPC\r\n */\r\nclass RPC {\r\n\tstatic Error(code, msg) {\r\n\t\treturn new ErrorMsg(code, msg || Message.msgErrorCodes[code] || 'Unexpected error');\r\n\t}\r\n\tdebug = false;\r\n\t_currentID = 1;\r\n\t_sessionId = 0;//for verify if the response belongs to the same session,dont change it after inited\r\n\t_checkerTimer;\r\n\t_sender;\r\n\tdefaultRequestTimeout;\r\n\tdefaultResponseTimeout;\r\n\toutReqList = new Map();//sessionId_id => out Request\r\n\tinReqList = new Map();//sessionId_id => in Request\r\n\t_checkerTimer;\r\n\tonRequest(inReq) { throw new Error('This method must be overwritten'); }//overwrite this\r\n\tconstructor(opt = {}) {\r\n\t\tthis.defaultRequestTimeout = opt.defaultRequestTimeout || 15000;\r\n\t\tthis.defaultResponseTimeout = opt.defaultResponseTimeout || 15000;\r\n\t\tthis._sessionId = opt.sessionId || RPC.generateRandom();\r\n\t\tthis.debug = opt.debug ?? false;\r\n\t}\r\n\t//sender side\r\n\t/**\r\n\t * @description generate id (exclude 0)\r\n\t * @returns {number}  \r\n\t */\r\n\t_generateId() {\r\n\t\tif (this.outReqList.size === 0xFFFFFFFF) return false;//no id can be used\r\n\t\twhile (this.outReqList.has(`${this._sessionId}_${this._currentID}`)) {//find available id\r\n\t\t\tthis._currentID++;\r\n\t\t\tif (this._currentID === 0xFFFFFFFF) this._currentID = 1;\r\n\t\t}\r\n\t\treturn this._currentID;\r\n\t}\r\n\r\n\t/**\r\n\t * @description buffer handle\r\n\t * @param {ArrayBuffer} data\tdata from remote rpc sender\r\n\t * @param {*} source define a source, which will be attached to request object\r\n\t */\r\n\thandle(data, source) {\r\n\t\tlet Message_msg = new Message(data);\r\n\t\tif (Message_msg.isRequest === true) {//it's a request\r\n\t\t\tthis._requestHandle(Message_msg, source);\r\n\t\t} else {//it's a response\r\n\t\t\tthis._responseHandle(Message_msg, source);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description send request\r\n\t * @async\r\n\t * @param {*} data\r\n\t * @param {object} [opt]\r\n\t * @param {number} [opt.timeout] timeout for this request\r\n\t * @param {boolean} [opt.noResponse] let remote know dont respond this request\r\n\t * @param {function(Request)} [getRequest] a function for getting the request instance\r\n\t * @returns {*}  request result\r\n\t */\r\n\tasync request(data, opt, getRequest) {\r\n\t\tif (typeof opt !== 'object') opt = {};\r\n\t\tlet id = 0, request, rand;\r\n\t\tif (opt.noResponse !== true) {\r\n\t\t\tif ((id = this._generateId()) === false) throw (new Error('No free id'));\r\n\t\t}\r\n\t\tif (id !== 0) {\r\n\t\t\trand = RPC.generateRandom();\r\n\t\t}\r\n\t\tlet buffer = Message.pack(this._sessionId, true, data, id, rand);\r\n\r\n\t\treturn new Promise((ok, fail) => {\r\n\t\t\tif (id !== 0) {\r\n\t\t\t\trequest = new Request(this, id, (err, res) => {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\tif (this.debug) {\r\n\t\t\t\t\t\t\tconsole.debug('RPC receive error:', 'req:', data, 'res:', err);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tfail(err);\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tok(res);\r\n\t\t\t\t}, rand);\r\n\t\t\t\tthis.outReqList.set(`${this._sessionId}_${id}`, request);\r\n\t\t\t\trequest.setTimeout(opt.timeout || this.defaultRequestTimeout);\r\n\t\t\t\tif (getRequest) getRequest(request);\r\n\t\t\t}\r\n\t\t\tthis._send(buffer).then(err => {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tif (this.debug) {\r\n\t\t\t\t\t\tconsole.debug('RPC send error', 'req:', data, 'err:', err);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfail(err);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\t/**\r\n\t * @description\tsend control message\r\n\t * @async\r\n\t * @param {number} name\r\n\t * @param {*} data\r\n\t * @returns {*} control response\r\n\t */\r\n\tcontrol(name, data) {\r\n\t\tlet msg = new ControlMsg(name, data);\r\n\t\treturn this.request(msg);\r\n\t}\r\n\t/**\r\n\t * @description delete the req instance from map\r\n\t * @param {Request|InRequest} req\r\n\t */\r\n\tdelete(req) {\r\n\t\tif (req instanceof Request) {\r\n\t\t\tconst id = `${this._sessionId}_${req.id}`;\r\n\t\t\tif (this.outReqList.get(id) === req)\r\n\t\t\t\tthis.outReqList.delete(id);\r\n\t\t\telse { throw (new Error('Deleting unknown req')) }\r\n\t\t\treq._destructor();\r\n\t\t} else if (req instanceof InRequest) {\r\n\t\t\tconst id = `${req.msg.sessionId}_${req.msg.id}`;\r\n\t\t\tif (this.inReqList.get(id) === req)\r\n\t\t\t\tthis.inReqList.delete(id);\r\n\t\t\telse { throw (new Error('Deleting unknown inReq')) }\r\n\t\t\treq._destructor();\r\n\t\t} else {\r\n\t\t\tif (this.debug) console.error('arg: ', req);\r\n\t\t\tthrow (new Error('Wrong type'));\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\tset sender of data.\r\n\t * @description\tsync sender : return send Error;\r\n\t * @description\tasync sender : resolve to send Error;\r\n\t * @param {function} func\r\n\t */\r\n\tsetSender(func) {\r\n\t\tif (typeof func !== 'function')\r\n\t\t\tthrow (new TypeError('not a function'));\r\n\t\t/*\r\n\t\t\tsync sender:return send Error\r\n\t\t*/\r\n\t\tthis._sender = func;\r\n\t}\r\n\t/**\r\n\t * @description\tsend buffer by sender function\r\n\t * @param {ArrayBuffer} buf\r\n\t * @returns {Promise<Error>}  \r\n\t */\r\n\tasync _send(buf) {\r\n\t\tif (this._sender) {\r\n\t\t\treturn this._sender(buf);\r\n\t\t}\r\n\t\tthrow (new Error('sender not defined'));\r\n\t}\r\n\t//receviver side\r\n\t/**\r\n\t * @description\tmake a message to respond the request\r\n\t * @param {InRequest} InRequest_req\r\n\t * @param {*} data\r\n\t */\r\n\t_respond(InRequest_req, data) {\r\n\t\tlet msg = InRequest_req.msg;\r\n\t\tif (this.inReqList.get(`${msg.sessionId}_${msg.id}`) !== InRequest_req) {\r\n\t\t\tif (this.debug) console.debug('Missing id');\r\n\t\t\t//ignore ids that not exist\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (msg.hasID) {//only messages have id should be responded\r\n\t\t\tlet Buffer_buf = Message.pack(InRequest_req.msg.sessionId, false, data, msg.id, msg.random);\r\n\t\t\tthis._send(Buffer_buf);\r\n\t\t}\r\n\t\t//remove saved inReq\r\n\t\tthis.delete(InRequest_req);\r\n\t}\r\n\t/**\r\n\t * @description\thandle control operation\r\n\t * @param {*} code received control code\r\n\t * @param {*} data received control data\r\n\t * @param {*} source define a source, which will be attached to request object\r\n\t */\r\n\tasync _controlHandle(Message_msg, source) {\r\n\t\tconst ctrlCode = Message_msg.type;\r\n\t\tconst data = Message_msg.data();\r\n\t\tswitch (ctrlCode) {\r\n\t\t\tcase ControlMsg.codes.abort: {//cancel an operation\r\n\t\t\t\tlet InRequest_req = this.inReqList.get(`${Message_msg.sessionId}_${data}`);//data: id\r\n\t\t\t\tif (!InRequest_req)\r\n\t\t\t\t\treturn;//ignore\r\n\t\t\t\tInRequest_req._abortMsg('remote abort');\r\n\t\t\t\tthis.delete(InRequest_req);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tdefault: {\r\n\t\t\t\tif (this.debug) console.debug('Unknown control code:' + ctrlCode);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\thandle received request\r\n\t * @param {Message} Message_msg\r\n\t * @param {*} source define a source, which will be attached to request object\r\n\t */\r\n\tasync _requestHandle(Message_msg, source) {\r\n\t\tconst sid_id = `${Message_msg.sessionId}_${Message_msg.id}`;\r\n\t\tif (this.inReqList.has(sid_id)) {\r\n\t\t\tthis._respond(Message_msg, RPC.Error(4104));//Duplicate id\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tlet InRequest_req = new InRequest(Message_msg, this, source);//create a response for the request\r\n\t\tif (Message_msg.id) {\r\n\t\t\tInRequest_req.setTimeout(this.defaultResponseTimeout);\r\n\t\t\tthis.inReqList.set(sid_id, InRequest_req);\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tlet result;\r\n\t\t\tif (Message_msg.isCtrl === true) {//it's a control pack\r\n\t\t\t\tresult = await this._controlHandle(Message_msg, source);\r\n\t\t\t} else {\r\n\t\t\t\tresult = await this.onRequest(InRequest_req);\r\n\t\t\t}\r\n\t\t\tif (InRequest_req.msg && InRequest_req.msg.id && (this.inReqList.get(sid_id) === InRequest_req)) {\r\n\t\t\t\tthis._respond(InRequest_req, result);\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tthis._respond(InRequest_req, err);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\thandle received response\r\n\t * @param {Message} Message_msg\r\n\t * @param {*} source define a source, which will be attached to request object\r\n\t */\r\n\t_responseHandle(Message_msg, source) {\r\n\t\tlet Request_req = this.outReqList.get(`${Message_msg.sessionId}_${Message_msg.id}`);\r\n\t\tif (!Request_req) {\r\n\t\t\tif (this.debug) console.debug('no req for id:' + Message_msg.id);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (Request_req.random !== Message_msg.random)\r\n\t\t\treturn;//ignore wrong response\r\n\t\tif (Message_msg.isError) {\r\n\t\t\tRequest_req.callback(Message_msg.data());\r\n\t\t} else {\r\n\t\t\tRequest_req.callback(null, Message_msg.data());\r\n\t\t}\r\n\t\tthis.delete(Request_req);\r\n\t}\r\n\t/**\r\n\t * @description\tgenerate a random number\r\n\t * @static\r\n\t * @returns {number}  \r\n\t */\r\n\tstatic generateRandom() {\r\n\t\treturn Math.round(0xffffffff * Math.random());\r\n\t}\r\n\t/**\r\n\t *destroy this instance and directly return error for all requests\r\n\t */\r\n\tdestroy() {\r\n\t\tfor (let [sid_id, request] of this.outReqList) {\r\n\t\t\trequest.callback(new Error('connection destroyed'));\r\n\t\t}\r\n\t\tfor (let [sid_id, InRequest_req] of this.inReqList) {\r\n\t\t\tInRequest_req._abortMsg('connection destroyed');\r\n\t\t}\r\n\t\tthis.outReqList.clear();\r\n\t\tthis.inReqList.clear();\r\n\t}\r\n}\r\n\r\n/* \r\nThe following classes have been merged from another separate package and introduce some breaking changes. Here's a list:\r\n*   RemoteCallback's `send` is removed, its functionality now resides in `RPC.request`.\r\n*   RemoteCallback's `handleRPC` is removed, its functionality now resides in `RPC.handle`.\r\n*   RemoteCallback's `setRPCSender` is removed, its functionality now resides in `RPC.setSender`.\r\n*   RemoteCallback's `request` has been renamed to `remoteCall`.\r\n*/\r\n/**\r\n * RemoteCallback is used to call remote methods and obtain results in a fixed data format.\r\n * @class RemoteCallback\r\n * @extends {RPC}\r\n */\r\nclass RemoteCallback extends RPC {\r\n\topts = {};\r\n\thandleArguments = (msg, inReq) => [msg.arg, inReq]; // Defines the arguments passed to handle; defaults to the message argument and request object.\r\n\tconstructor(opt) {\r\n\t\tsuper(opt);\r\n\t}\r\n\tasync onRequest(inReq) {\r\n\t\ttry {\r\n\t\t\treturn await this._handleRequest(inReq);//pass an InRequest object for abort checking \r\n\t\t} catch (err) {\r\n\t\t\tif (typeof err == 'string') {\r\n\t\t\t\tthrow (RPC.Error(4100, err));\r\n\t\t\t} else if (err instanceof Error) {\r\n\t\t\t\tif (this.debug) console.error(err);\r\n\t\t\t\tthrow (RPC.Error(4100, 'handle error'));\r\n\t\t\t} else {\r\n\t\t\t\tthrow (new TypeError('invalid error type:' + typeof err));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description\t处理请求\r\n\t * @param {InRequest} inReq\r\n\t */\r\n\tasync _handleRequest(inReq) {\r\n\t\tlet msg = inReq.data();\r\n\t\tif (typeof msg !== 'object' || msg === null) {\r\n\t\t\tif (this.debug) console.error('invalid request', inReq);\r\n\t\t\tthrow ('invalid message type');\r\n\t\t}\r\n\t\tif ('_' in msg === false) {\r\n\t\t\tthrow ('No opt found');\r\n\t\t}\r\n\t\tlet handle = this.opts[msg._];\r\n\t\tif (handle) {\r\n\t\t\tlet result = await handle(...this.handleArguments(msg, inReq));\r\n\t\t\tinReq.responded = true;//mark as responded\r\n\t\t\treturn result;\r\n\t\t} else {\r\n\t\t\tthrow (`unknown handle type '${msg._}'`);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * @description Sends an RPC request to the remote end.\r\n\t * @param {string} opt Operation name.\r\n\t * @param {*} arg Arguments to send with the request.\r\n\t * @param {function(Error,any)} callback The remote response will be passed directly to this function. If not defined, the function returns a Promise providing the result.\r\n\t * @param {object} [rpcOpt] Option for `this.rpc.request`.\r\n\t * @returns {undefined|Promise<*>} This Promise returns the request result data.\r\n\t */\r\n\tremoteCall(opt, arg, rpcOpt) {\r\n\t\treturn super.request({ _: opt, arg }, rpcOpt);\r\n\t}\r\n\t/**\r\n\t * @description Registers the operation handling function for this side.\r\n\t * @param {string} opt\r\n\t * @param {function(arg,InRequest)} func  (request parameter, InRequest object)\r\n\t */\r\n\tregister(opt, func) {\r\n\t\tif (typeof opt !== 'string') {\r\n\t\t\tthrow (new TypeError('name should be a string'));\r\n\t\t}\r\n\t\tif (typeof func !== 'function') {\r\n\t\t\tthrow (new TypeError('fun should be a function'));\r\n\t\t}\r\n\t\tif (opt in this.opts) {\r\n\t\t\tthrow (new Error(`operation ${opt} already been registered`));\r\n\t\t}\r\n\t\tthis.opts[opt] = func;\r\n\t}\r\n\t/**\r\n\t * @description\tRemove the specified operation handler\r\n\t * @param {string} opt\r\n\t */\r\n\tderegister(opt) {\r\n\t\tdelete this.opts[opt];\r\n\t}\r\n\tdestroy() {\r\n\t\tsuper.destroy();\r\n\t\tthis.opts = null;\r\n\t}\r\n\trequest() {\r\n\t\tthrow (new Error('This method is disabled on sub class, use \"remoteCall\" instead.'));\r\n\t}\r\n\thandleRPC() {\r\n\t\tthrow (new Error('This method is removed, use \"remoteCall\" handle.'));\r\n\t}\r\n\tsetRPCSender() {\r\n\t\tthrow (new Error('This method is removed, use \"setSender\" handle.'));\r\n\t}\r\n}\r\n\r\nmodule.exports = {\r\n\tRPC,\r\n\tRemoteCallback,\r\n};\r\n","import { getDefaultExportFromCjs } from \"\u0000commonjsHelpers.js\";\nimport { __require as requireJsObjRpc } from \"D:\\\\Repo\\\\js-obj-rpc\\\\index.js\";\nvar jsObjRpcExports = requireJsObjRpc();\nexport { jsObjRpcExports as __moduleExports };\nexport default /*@__PURE__*/getDefaultExportFromCjs(jsObjRpcExports);"],"names":["strToUint8","str","encoder","encode","uint8ToStr","uint8","decoder","decode","getSliceInArrayBuffer","typedArray","buffer","slice","byteOffset","byteLength","concatArrayBuffers","buffers","offsets","Array","length","totalLength","ai","ArrayBuffer","Uint8Array","result","i","set","SUPPORT_ARRAYBUFFER","global","TypedArray","Float32Array","prototype","constructor","__proto__","isView","a","DataView","TextEncoder","TextDecoder","tmpFloat64Array1","Float64Array","tmpUint8Array5","tmpUint8Array13","Message","id","random","head","type","_data","hasID","payload","sessionId","isRequest","data","getUint32","subarray","TypeError","Error","view","isCtrl","isError","ControlMsg","parseData","JSON","parse","getFloat64","bStr","BigInt","toFrameData","code","buf","debug","console","error","ErrorMsg","stringify","msg","setFloat64","toString","_pack","req","err","randomNum","array","fill","setUint32","bufs","push","pack","msgErrorCodes","isValidId","message","cache","codes","abort","name","Request","responded","timeout","rpc","callback","cb","control","delete","args","setTimeout","time","clearTimeout","_timeout","_destructor","InRequest","aborted","source","onAbort","Message_msg","_reachTimeout","_abortMsg","str_msg","_respond","RPC","_currentID","_sessionId","_checkerTimer","_sender","defaultRequestTimeout","defaultResponseTimeout","outReqList","Map","inReqList","onRequest","opt","generateRandom","_generateId","size","has","handle","_requestHandle","_responseHandle","request","getRequest","rand","noResponse","Promise","ok","fail","res","_send","then","get","setSender","func","InRequest_req","Buffer_buf","_controlHandle","ctrlCode","sid_id","Request_req","Math","round","destroy","clear","jsObjRpc","RemoteCallback","opts","handleArguments","inReq","arg","_handleRequest","_","remoteCall","rpcOpt","register","deregister","handleRPC","setRPCSender","jsObjRpcExports","requireJsObjRpc","getDefaultExportFromCjs"],"mappings":"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"}